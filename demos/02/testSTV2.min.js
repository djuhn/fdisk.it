function voteset(e,t){votes=[],names=[],fships=[],namesText=[],totcands=0,totvotes=0,candcount=0,votecount=0,votenum=[],outputstring=" ",totlivevotes=0,wincount=0,winner=null,least=null,mincount=null,eliminated=null,elimcount=null,roundnum=0,quota=null,voteweight=[],elected=[],quotacount=null,greatest=null,maxcount=null,roundelected=null;var n='[{"Deleted":0,"Name":"Dr Alpha","Fellowship":"1980-01-01T00:00:00.000Z","nID":0},{"Deleted":0,"Name":"Dr Bravo","Fellowship":"1990-01-01T23:00:00.000Z","nID":1},{"Deleted":0,"Name":"Dr Charlie","Fellowship":"2000-01-01T00:00:00.000Z","nID":2}]';if(nominees=JSON.parse(n),outputstring="",seats=t,console.log(seats+" seats"),nominees.length>0)if(totcands=_.filter(nominees,function(e){if(0==e.Deleted)return!0}).length,console.log(totcands+" candidates"),totvotes=vJS.length,console.log(totvotes+" total votes"),0==seats||0==totcands||0==totvotes||totvotes<seats)console.log("There was not enough data to calculate the election results."),$("#bang").append("Not enough data to run an election."),outputstring="<p>There was not enough data (candidates, votes) to run results.</p>";else{for(m=0;m<totvotes;m++)votes[m]=new Array,voteweight[m]=1;quota=Math.ceil(100*totvotes/(seats+1))/100,namesinput(e)}}function namesform(e){}function namesinput(e){candcount=0;var t=0;_.each(nominees,function(e){0==e.Deleted&&(names[candcount]=e.nID,candcount+=1),fships[t]=e.Fellowship,namesText[t]=e.Name,t+=1}),votesform(e)}function votesform(e){_.each(vJS,function(e){var t=e.VotedFor,n=0;_.each(t,function(e){votes[votecount][n]=e,n+=1}),votecount+=1}),countvotes(e)}function countvotes(e){for(v=0;v<totvotes;v++)votes[v].push("voteend");shiftnone(e)}function shiftnone(e){if(wincount==seats)result();else{for(roundnum+=1,v=0;v<totvotes;v++)"none"==votes[v][0]&&(votes[v].shift(),v-=1);for(console.log("<br><br>Round "+roundnum),$("#bang").append('<h4 class="ui sub header">Round '+roundnum+"</h4>"),v=0;v<totvotes;v++)for(c=0;c<=totcands;c++)void 0!==votes[v][c]&&"none"!==votes[v][c]&&"voteend"!==votes[v][c];roundnum<50?countfirst(e):console.log("Error in processing results.  Please contact software administrator. [ref: JE101]")}}function countfirst(e){for(c=0;c<totcands;c++)votenum[c]=0;for(v=0;v<totvotes;v++)for(c=0;c<totcands;c++)names[c]==votes[v][0]&&(votenum[c]+=1);for(_.each(votenum,function(e,t){console.log(namesText[t]+" : "+votenum[t]),$("#bang").append(namesText[t]+" : "+votenum[t]+"<br>")}),quotacount=0,c=0;c<totcands;c++)votenum[c]>quota&&(quotacount+=1);0==quotacount?findmin(e):overquota(e)}function findmin(e){for(v=0;v<totvotes;v++)for(c=0;c<totcands;c++)for(q=0;q<totcands;q++)names[q]==votes[v][c]&&0==votenum[q]&&(votes[v][c]="none");for(livecount=0,c=0;c<totcands;c++)votenum[c]>0&&(livecount+=1);if(livecount+wincount==seats)allliveelected(e);else{for(least=totvotes,console.log("totcands="+totcands),c=0;c<totcands;c++)console.log("so checking that c="+c+" and least="+least+" and votenum[c]="+votenum[c]),votenum[c]<least&&votenum[c]>0&&(console.log("match: least is now = "+votenum[c]),least=votenum[c]),0==votenum[c]&&(least=0);for(console.log("Fewest votes won by a candidate = "+least+"."),mincount=0,c=0;c<totcands;c++)votenum[c]==least&&(mincount+=1);console.log("Number of candidates with the fewest votes = "+mincount+"."),1==mincount?(outputstring+=mincount+" candidate with the fewest votes: ",monomin(e)):(outputstring+=mincount+" candidates with the fewest votes. ",multimin(e))}}function monomin(e){for(c=0;c<totcands;c++)votenum[c]==least&&(eliminated=c);console.log(namesText[names[eliminated]]+" is eliminated."),outputstring+="["+namesText[names[eliminated]]+"] is eliminated.<br><br>",removemin(e)}function multimin(e){for(elimcount=0,console.log("least ="+least),fsindex="1/1/1900",currwinner=-1,c=0;c<totcands;c++)votenum[c]==least&&(elimcount+=1,console.log(namesText[names[c]]+" is one of the "+mincount+" people with the least votes"),console.log(namesText[names[c]]+" date of fellowship: "+fships[names[c]]),moment(fships[names[c]]).isAfter(fsindex)&&(currwinner=c,fsindex=fships[names[c]]));$("#bang").append(namesText[names[currwinner]]+" has the most recent fellowship and so will be eliminated"),console.log(namesText[names[currwinner]]+" has the most recent fellowship and so will be eliminated"),outputstring+=" Of these, ["+namesText[names[currwinner]]+"] has the most recent fellowship and so will be eliminated.<br><br>",eliminated=currwinner,removemin(e)}function removemin(e){for(v=0;v<totvotes;v++)for(c=0;c<totcands;c++)votes[v][c]==names[eliminated]&&(votes[v][c]="none");totcands-=1,names.splice(eliminated,1),console.log(totcands+" totcands remaining"),totcands>0?shiftnone(e):($("#bang").append("Not enough candidates to fill seats"),console.log("Not enough candidates to fill seats"))}function overquota(e){for(greatest=0,c=0;c<totcands;c++)votenum[c]>greatest&&(greatest=votenum[c]);for(maxcount=0,c=0;c<totcands;c++)votenum[c]==greatest&&(maxcount+=1);roundelected=0,1==maxcount?monomax(e):multimax(e)}function monomax(e){for(c=0;c<totcands;c++)votenum[c]==greatest&&(roundelected=c);console.log(namesText[roundelected]+" has exceeded the quota and is elected."),$("#bang").append(namesText[roundelected]+" has exceeded the quota and is elected.<br>"),electmax(e)}function multimax(e){for(console.log("***MULTIMAX CALLED - DEBUG NOW!!!***"),tiebreakloser=Math.ceil(Math.random()*maxcount),elimcount=0,fsindex="1/1/3000",currwinner=-1,c=0;c<totcands;c++)votenum[c]==greatest&&(elimcount+=1,console.log(namesText[names[c]]+" is one of the "+mincount+" people with the most votes"),console.log(namesText[names[c]]+" date of fellowship: "+fships[names[c]]),moment(fships[names[c]]).isBefore(fsindex)&&(currwinner=c,fsindex=fships[names[c]]));$("#bang").append(namesText[names[currwinner]]+" has the earlier fellowship and so has won this round by tie break"),console.log(namesText[names[currwinner]]+" has the earlier fellowship and so has won this round by tie break"),roundelected=currwinner,electmax(e)}function electmax(e){for(elected[wincount]=names[roundelected],wincount+=1,v=0;v<totvotes;v++)votes[v][0]==names[roundelected]&&(voteweight[v]*=(votenum[roundelected]-quota)/votenum[roundelected]);for(v=0;v<totvotes;v++)for(c=0;c<totcands;c++)votes[v][c]==names[roundelected]&&(votes[v][c]="none");shiftnone(e)}function allliveelected(e){for(c=0;c<totcands;c++)votenum[c]>0&&(elected[wincount]=names[c],wincount+=1);shiftnone(e)}function result(){for(outputstring=1==seats?"<br>The election is complete and the elected candidate is:<br>":"<br>The election is complete and the elected candidates are:<br>",i=0;i<seats;i++)outputstring+=" <strong>"+namesText[elected[i]]+"</strong><br>";console.log(outputstring),$("#bang").append(outputstring)}$(document).ready(function(){function e(e){return"Dr Alpha"==e?"0":"Dr Bravo"==e?"1":"Dr Charlie"==e?"2":"Nil"==e?"none":void 0}function t(e){for(var t=e.slice().sort(),n=[],o=0;o<e.length-1;o++)t[o+1]==t[o]&&"none"!=t[o]&&n.push(t[o]);return n.length>0}$("#matrix").on("click",function(e){switch(e.target.innerHTML){case"Nil":e.target.innerHTML="Dr Alpha";break;case"Dr Alpha":e.target.innerHTML="Dr Bravo";break;case"Dr Bravo":e.target.innerHTML="Dr Charlie";break;case"Dr Charlie":e.target.innerHTML="Nil"}}),$("#subm").on("click",function(n){$("#V1").removeClass("red"),$("#V2").removeClass("red"),$("#V3").removeClass("red"),$("#V4").removeClass("red"),$("#V5").removeClass("red"),$("#V6").removeClass("red"),$("#V7").removeClass("red"),$("#V8").removeClass("red"),$("#V9").removeClass("red"),$("#V10").removeClass("red"),$("#V11").removeClass("red"),$("#V12").removeClass("red"),$("#V13").removeClass("red"),$("#V14").removeClass("red"),$("#V15").removeClass("red"),$("#V16").removeClass("red"),$("#V17").removeClass("red"),$("#V18").removeClass("red"),$("#V19").removeClass("red"),$("#V20").removeClass("red"),$("#V21").removeClass("red"),$("#V22").removeClass("red"),$("#V23").removeClass("red"),$("#V24").removeClass("red");var o=[],s=[],a=!1;s.push(e($("#1A").html())),s.push(e($("#1B").html())),s.push(e($("#1C").html())),1==t(s)&&(a=!0,$("#V1").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#2A").html())),s.push(e($("#2B").html())),s.push(e($("#2C").html())),1==t(s)&&(a=!0,$("#V2").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#3A").html())),s.push(e($("#3B").html())),s.push(e($("#3C").html())),1==t(s)&&(a=!0,$("#V3").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#4A").html())),s.push(e($("#4B").html())),s.push(e($("#4C").html())),1==t(s)&&(a=!0,$("#V4").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#5A").html())),s.push(e($("#5B").html())),s.push(e($("#5C").html())),1==t(s)&&(a=!0,$("#V5").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#6A").html())),s.push(e($("#6B").html())),s.push(e($("#6C").html())),1==t(s)&&(a=!0,$("#V6").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#7A").html())),s.push(e($("#7B").html())),s.push(e($("#7C").html())),1==t(s)&&(a=!0,$("#V7").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#8A").html())),s.push(e($("#8B").html())),s.push(e($("#8C").html())),1==t(s)&&(a=!0,$("#V8").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#9A").html())),s.push(e($("#9B").html())),s.push(e($("#9C").html())),1==t(s)&&(a=!0,$("#V9").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#10A").html())),s.push(e($("#10B").html())),s.push(e($("#10C").html())),1==t(s)&&(a=!0,$("#V10").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#11A").html())),s.push(e($("#11B").html())),s.push(e($("#11C").html())),1==t(s)&&(a=!0,$("#V11").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#12A").html())),s.push(e($("#12B").html())),s.push(e($("#12C").html())),1==t(s)&&(a=!0,$("#V12").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#13A").html())),s.push(e($("#13B").html())),s.push(e($("#13C").html())),1==t(s)&&(a=!0,$("#V13").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#14A").html())),s.push(e($("#14B").html())),s.push(e($("#14C").html())),1==t(s)&&(a=!0,$("#V14").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#15A").html())),s.push(e($("#15B").html())),s.push(e($("#15C").html())),1==t(s)&&(a=!0,$("#V15").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#16A").html())),s.push(e($("#16B").html())),s.push(e($("#16C").html())),1==t(s)&&(a=!0,$("#V16").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#17A").html())),s.push(e($("#17B").html())),s.push(e($("#17C").html())),1==t(s)&&(a=!0,$("#V17").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#18A").html())),s.push(e($("#18B").html())),s.push(e($("#18C").html())),1==t(s)&&(a=!0,$("#V18").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#19A").html())),s.push(e($("#19B").html())),s.push(e($("#19C").html())),1==t(s)&&(a=!0,$("#V19").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#20A").html())),s.push(e($("#20B").html())),s.push(e($("#20C").html())),1==t(s)&&(a=!0,$("#V20").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#21A").html())),s.push(e($("#21B").html())),s.push(e($("#21C").html())),1==t(s)&&(a=!0,$("#V21").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#22A").html())),s.push(e($("#22B").html())),s.push(e($("#22C").html())),1==t(s)&&(a=!0,$("#V22").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#23A").html())),s.push(e($("#23B").html())),s.push(e($("#23C").html())),1==t(s)&&(a=!0,$("#V23").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],s.push(e($("#24A").html())),s.push(e($("#24B").html())),s.push(e($("#24C").html())),1==t(s)&&(a=!0,$("#V24").addClass("red")),"none"==s[0]&&"none"==s[1]&&"none"==s[2]||o.push({VotedFor:s}),s=[],1==a?$("#bang").html("Your votes are invalid. Please check those in red and ensure you have not voted for the same candidate twice."):($("#bang").html(""),vJS=o,voteset(1,2))})});var votes=new Array,names=new Array,fships=new Array,namesText=new Array,totcands=0,totvotes=0,candcount=0,votecount=0,votenum=new Array,outputstring=" ",totlivevotes=0,wincount=0,winner,least,mincount,eliminated,elimcount,roundnum=0,quota,seats,voteweight=new Array,livecount,elected=new Array,quotacount,greatest,maxcount,roundelected,dbvotes="[]";vJS=JSON.parse(dbvotes);var candidates='[{"Deleted":0,"Name":"Dr Alpha","Fellowship":"1980-01-01T00:00:00.000Z","nID":0},{"Deleted":0,"Name":"Dr Bravo","Fellowship":"1990-01-01T23:00:00.000Z","nID":1},{"Deleted":0,"Name":"Dr Charlie","Fellowship":"2000-01-01T00:00:00.000Z","nID":2}]';nominees=JSON.parse(candidates);